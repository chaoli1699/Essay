/*! This file is created by gold.xitu.io. */
webpackJsonp([36],{706:function(module,exports,__webpack_require__){"use strict";function _interopRequireWildcard(obj){if(obj&&obj.__esModule)return obj;var newObj={};if(null!=obj)for(var key in obj)Object.prototype.hasOwnProperty.call(obj,key)&&(newObj[key]=obj[key]);return newObj["default"]=obj,newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{"default":obj}}var _keys=__webpack_require__(246),_keys2=_interopRequireDefault(_keys),_actions=__webpack_require__(21),actions=_interopRequireWildcard(_actions),_helpers=__webpack_require__(25),_notification=__webpack_require__(532),FETCH_LIMIT=50;module.exports={vuex:{getters:{user:function(state){return state.user},loading:function(state){return state.loading}},actions:actions},data:function(){return{NOTIFICATION_CATEGORIES:_helpers.NOTIFICATION_CATEGORIES,currentNotificationCategory:null,notifications:[],fetchMore:!0,uncheckedNotificationsCount:function(){var obj={};return(0,_keys2["default"])(_helpers.NOTIFICATION_CATEGORIES).forEach(function(key){return obj[key]=0}),obj}(),pointer:0}},computed:{notificationCategoryActionName:function(){switch(this.currentNotificationCategory){case"submit-entry":return"你推荐的 ";case"vote-like":return"赞同了你在沸点的回答";default:return _helpers.NOTIFICATION_CATEGORIES[this.currentNotificationCategory].name+"了"}}},created:function(){return this.$isRole(["editor","admin"])&&(delete this.NOTIFICATION_CATEGORIES["submit-entry"],delete this.uncheckedNotificationsCount["submit-entry"]),this.user?(this.setUncheckedNotificationsCount(0),void this.fetchUncheckedNotificationsCount()):this.$Route.route({name:"index"})},route:{data:function(){var category=this.$route.params.category;category?this.setCurrentNotificationCategory(category):this.currentNotificationCategory="collection"}},watch:{currentNotificationCategory:function(category){this.pointer=0,this.fetchNotifications()}},filters:{notificationUserName:function(notification){return notification.get("notifierUser")&&notification.get("notifierUser").get("username")},notificationEntryTitle:function(notification){return notification.get("entry")?notification.get("entry").get("title"):notification.get("submitEntry")?notification.get("submitEntry").get("title"):void 0},submitEntryState:function(notification){if(notification.get("submitEntryState"))switch(notification.get("submitEntryState")){case"success":return"通过审核";case"wait":return"正在审核";case"failed":return"未通过审核"}},showComment:function(notification){var type=notification.get("type");return"comment"==type||"reply"==type||"comment-like"==type||"vote-like"==type},commentContent:function(notification){var comment=void 0,reply=void 0;switch(notification.get("type")){case"comment":if(comment=notification.get("comment"))return"评论："+comment.get("content");break;case"reply":if(reply=notification.get("reply"))return"回复："+reply.get("content");break;case"comment-like":if(comment=notification.get("comment"))return"我的评论："+comment.get("content");break;case"vote-like":if(comment=notification.get("comment"))return"我的回答："+comment.get("content")}return""}},methods:{fetchUncheckedNotificationsCount:function(){var _this=this,typeList=((0,_keys2["default"])(this.uncheckedNotificationsCount),new AV.Query(UserNotification),(0,_keys2["default"])(this.uncheckedNotificationsCount));(0,_notification.getTypeListUneadNotificationCount)(typeList).then(function(res){(0,_keys2["default"])(res).forEach(function(key){"system"!==key&&(_this.uncheckedNotificationsCount[key]=+res[key])})})["catch"](_helpers.outputError),(0,_notification.getUnreadSystemNotificationCount)().then(function(count){_this.uncheckedNotificationsCount.system=count})["catch"](_helpers.outputError)},isCurrentNotificationCategory:function(category){return this.currentNotificationCategory===category},setCurrentNotificationCategory:function(category){this.$route.router.go({name:"notification-category",params:{category:category}}),this.currentNotificationCategory=category},generateNotificationQuery:function(){var notificationQuery=new AV.Query(UserNotification);switch(this.currentNotificationCategory){case"collection":notificationQuery.include("entry.user").include("collection");case"follow":break;case"comment":notificationQuery.include("entry.user").include("comment");break;case"reply":notificationQuery.include("entry.user").include("reply");break;case"comment-like":notificationQuery.include("entry.user").include("comment");break;case"vote-like":notificationQuery.include("entry.user").include("comment");break;case"submit-entry":notificationQuery.include("entry").include("submitEntry")}return notificationQuery.include("notifierUser").equalTo("user",this.user).equalTo("type",this.currentNotificationCategory).descending("createdAt").limit(FETCH_LIMIT)},fetchNotifications:function(){var _this2=this;if(this.fetchMore=!0,this.notifications=[],this.showLoading(),"system"===this.currentNotificationCategory)return this.fetchSystemNotification();var notificationQuery=this.generateNotificationQuery();notificationQuery.find().then(function(notifications){_this2.fetchMore=notifications.length==FETCH_LIMIT,_this2.notifications=notifications})["catch"](_helpers.outputError).always(function(){_this2.hideLoading()})},fetchMoreNotifications:function(){var _this3=this;if(this.showLoading(),"system"===this.currentNotificationCategory)return this.fetchSystemNotification();var notificationQuery=this.generateNotificationQuery();notificationQuery.skip(this.notifications.length).find().then(function(notifications){_this3.fetchMore=notifications.length==FETCH_LIMIT,_this3.notifications.push.apply(_this3.notifications,notifications)})["catch"](_helpers.outputError).always(function(){_this3.hideLoading()})},fetchSystemNotification:function(){var _this4=this;return(0,_notification.querySystemNotification)(this.pointer).then(function(res){var list=res.notifications||[];_this4.pointer=res.pointer||_this4.pointer,_this4.fetchMore=20===list.length,list.forEach(function(listItem){!listItem.check&&listItem.message.includes("邀请码")&&_this4.showBluePoint()}),_this4.notifications=list.map(_this4.translateSystemNotification),_this4.hideLoading()})["catch"](function(err){_this4.hideLoading(),(0,_helpers.outputError)(err)})},translateSystemNotification:function(notification){var res={id:notification.id,type:"system",attributes:{},get:function(key){return notification[key]||res[key]},set:function(key,val){return notification[key]=val,res[key]=val,res},save:function(){return AV.Promise.resolve(res)},createdAt:new Date(notification.date)};return res},routeAndSetCheckToTrue:function(notification){var _this5=this,unread=!notification.get("check"),type=this.currentNotificationCategory;switch(notification.set("check",!0).save().then(function(){unread&&"system"!==type&&(_this5.uncheckedNotificationsCount[type]-=1)})["catch"](_helpers.outputError),notification.get("type")){case"collection":this.$Route.routeEntry(notification.get("entry"));break;case"follow":this.$Route.routeUser(notification.get("notifierUser"));break;case"comment":this.$Route.routeEntry(notification.get("entry"),notification.get("comment"));break;case"reply":this.$Route.routeEntry(notification.get("entry"),notification.get("reply"));break;case"comment-like":this.$Route.routeEntry(notification.get("entry"),notification.get("comment"));break;case"vote-like":this.$Route.routeEntry(notification.get("entry"),notification.get("comment"));break;case"submit-entry":notification.get("entry")&&this.$Route.routeEntry(notification.get("entry"));break;default:notification.get("entry")&&this.$Route.routeEntry(notification.get("entry"))}},setCategoryNotificationCheckTrue:function(){var _this6=this,type=this.currentNotificationCategory;return(0,_notification.readAllNotificationInType)(type).then(function(){_this6.uncheckedNotificationsCount[type]=0,_this6.notifications.forEach(function(notification){notification.attributes.check=!0})})["catch"](_helpers.outputError)}}}},877:function(module,exports){module.exports='<div class="view no-padding"><nav class=bg><div class=container><div class=actions><div v-for="notificationCategory in NOTIFICATION_CATEGORIES" :class="{true: isCurrentNotificationCategory($key)}" @click=setCurrentNotificationCategory($key) class=action><i :class=notificationCategory.icon></i><span>{{notificationCategory.name}}</span><span v-show="uncheckedNotificationsCount[$key] &gt; 0" class=notification> {{uncheckedNotificationsCount[$key]}}</span></div></div><div class="actions secondary"><div v-if="notifications.length &gt; 0" @click=setCategoryNotificationCheckTrue() class=action><i class=ion-checkmark-circled></i><span>清除通知</span></div></div></div></nav><div class=container><table v-if="notifications.length &gt; 0" class=table><tr v-for="notification in notifications" @click=routeAndSetCheckToTrue(notification) :class="{read: notification.get(&quot;check&quot;)}" class=text-pointer><td v-if="notification.get(\'type\') !== \'system\'"><strong @click="$Route.routeUser(notification.get(&quot;notifierUser&quot;), $event)" class=text-pointer><img :src="notification.get(&quot;notifierUser&quot;) | avatar" class="avatar inline"/><span>{{notification | notificationUserName}}</span></strong> {{notificationCategoryActionName}}&nbsp<strong v-if="currentNotificationCategory == &quot;follow&quot;">我</strong><strong v-if="currentNotificationCategory != &quot;follow&quot;" class=text-pointer>{{notification | notificationEntryTitle}}</strong><span v-if="notification.get(\'type\') === \'submit-entry\'"> {{notification | submitEntryState}}</span><div v-if="notification | showComment" class=reply-comment>{{notification | commentContent}}</div></td><td v-else=v-else><span>{{{ notification.get(\'message\') }}}</span></td><td class=text-center><i class="ion-record read-icon"></i></td><td width=120 class=text-right><i class=ion-clock></i><span>{{notification.createdAt | timeFromNow}}</span></td></tr></table><p v-if=fetchMore class="text-center text-muted"><span v-if=loading><i class="ion-load-c spin"></i><span>加载中</span></span><button v-if=!loading @click=fetchMoreNotifications() class=gray>加载更多</button></p><p v-if=!fetchMore class="text-center text-muted">无新的通知</p></div></div>'},981:function(module,exports,__webpack_require__){var __vue_script__,__vue_template__,__vue_styles__={};__vue_script__=__webpack_require__(706),__vue_template__=__webpack_require__(877),module.exports=__vue_script__||{},module.exports.__esModule&&(module.exports=module.exports["default"]);var __vue_options__="function"==typeof module.exports?module.exports.options||(module.exports.options={}):module.exports;__vue_template__&&(__vue_options__.template=__vue_template__),__vue_options__.computed||(__vue_options__.computed={}),Object.keys(__vue_styles__).forEach(function(key){var module=__vue_styles__[key];__vue_options__.computed[key]=function(){return module}})}});